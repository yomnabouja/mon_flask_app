{% extends 'index.html' %}
{% block navbar %}{% endblock %} 


{% block title %}Tableau de bord - RecoFlix{% endblock %}

{% block styles %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    :root {
            --primary-color: #5d5dff;
            --secondary-color: #6c757d;
            --light-gray: #f0f2f5;
            --dark-gray: #4a4a4a;
            --white: #fff;
            --font-family: 'Poppins', sans-serif;
        }

        /* Styles pour le mode sombre (ajouté/corrigé) */
        body.dark {
            --primary-color: #9d9dff;
            --secondary-color: #adb5bd;
            --light-gray: #1a1a1a;
            --dark-gray: #f0f2f5;
            --white: #2c2c2c;
            color: var(--dark-gray);
        }

        .dark .header-nav,
        .dark .film-card,
        .dark .modal-content {
            background: var(--white);
            box-shadow: 0 4px 6px rgba(255, 255, 255, 0.05);
        }

        .dark .nav-link,
        .dark .search-input {
            color: var(--dark-gray);
        }
        .dark .search-input {
            background-color: var(--light-gray);
        }
        .dark .search-input:focus {
            box-shadow: 0 0 0 0.25rem rgba(157, 157, 255, 0.25);
        }
        .dark .section-title::after {
            background-color: var(--primary-color);
        }
        .dark .hero-film {
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
        }
        .dark .hero-content h1 {
            background: linear-gradient(45deg, var(--primary-color), #5d5dff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .dark .btn-action {
            background: var(--primary-color);
            border-color: var(--primary-color);
        }
        .dark .btn-action:hover {
            box-shadow: 0 4px 8px rgba(157, 157, 255, 0.3);
        }
        .dark .modal-header {
            background-color: var(--primary-color);
        }
        .dark .chat-message.bot {
            background-color: #333;
            color: #f1f1f1;
        }
        .dark .chat-message.user {
            background-color: #5d5dff;
            color: #fff;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-gray);
            color: var(--dark-gray);
            padding-top: 70px;
        }

        .header-nav {
            background: var(--white);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            transition: top 0.3s;
        }
        .logo-text {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        .nav-link {
            color: var(--dark-gray);
            font-weight: 500;
            transition: color 0.2s, transform 0.2s;
        }

        .nav-link:hover {
            color: var(--primary-color);
            transform: translateY(-2px);
        }

        .search-container {
            flex-grow: 1;
            max-width: 400px;
            margin: 0 auto;
        }
        .search-input {
            border-radius: 50px;
            background-color: var(--light-gray);
            border: none;
            padding-left: 20px;
            transition: box-shadow 0.3s;
        }
        .search-input:focus {
            background-color: var(--white);
            box-shadow: 0 0 0 0.25rem rgba(93, 93, 255, 0.25);
        }
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-gray);
            margin-bottom: 2rem;
            position: relative;
        }
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 60px;
            height: 4px;
            background-color: var(--primary-color);
            border-radius: 2px;
        }

        .scrollable-row {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 1.5rem;
            gap: 1.5rem;
        }

        .scrollable-row::-webkit-scrollbar {
            height: 8px;
        }
        .scrollable-row::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .film-card {
            flex: 0 0 auto;
            width: 250px;
            scroll-snap-align: start;
            border: none;
            background-color: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            position: relative; /* Pour positionner le bouton de suppression */
        }

        .film-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }
        .film-card img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            border-radius: 12px;
        }
        .remove-favorite-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(220, 53, 69, 0.8);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .film-card:hover .remove-favorite-btn {
            opacity: 1;
        }

        .hero-film {
            background: linear-gradient(135deg, #f0f2f5, #e0e4e9);
            border-radius: 1rem;
            padding: 4rem;
            margin-bottom: 3rem;
        }

        .hero-content h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-color), #8d8dff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-action {
            background: var(--primary-color);
            border-color: var(--primary-color);
            border-radius: 50px;
            padding: 0.75rem 2rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(93, 93, 255, 0.3);
        }

        .modal-content {
            border-radius: 1rem;
            background-color: var(--white);
        }
        .modal-header {
            background-color: var(--primary-color);
            color: var(--white);
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }

        .modal-body-film {
            display: flex;
            gap: 2rem;
        }

        .modal-body-film img {
            width: 40%;
            object-fit: cover;
            border-radius: 12px;
        }

        .modal-footer {
            border-top: none;
        }

        .director-modal-body img {
            width: 150px;
            height: 150px;
        }

        /* Styles pour le chatbot */
        .fixed-bottom-right {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
        }

        .fixed-bottom-right:hover {
            transform: scale(1.1);
        }

        .fixed-bottom-right-lg {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 450px;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.25);
            background-color: #fff;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .chatbot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 1rem 1rem 0 0;
            background-color: var(--primary-color);
            color: var(--white);
        }

        .chatbot-body {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .chatbot-footer {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 0.5rem;
        }

        .hidden {
            display: none;
        }
        .chat-message {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 85%;
            word-wrap: break-word;
        }
        .chat-message.user {
            background-color: #e9f5ff;
            color: #212529;
            align-self: flex-end;
            border-bottom-right-radius: 0;
        }
        .chat-message.bot {
            background-color: #f1f1f1;
            color: #212529;
            align-self: flex-start;
            border-bottom-left-radius: 0;
        }

        .loading .spinner-border {
            color: var(--secondary-color);
        }
       /* Style du conteneur des notifications */
#dynamic-alert-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1050;
    width: 350px;
    max-width: 90%;
}

/* Style de base des notifications */
.toast-notification {
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    padding: 1rem 1.5rem;
    color: #333;
    display: flex;
    align-items: center;
    position: relative;
    overflow: hidden;
    margin-bottom: 1rem;
    transform: translateX(120%); /* Commence à l'extérieur de l'écran */
    animation: slide-in 0.5s forwards ease-out; /* Animation d'entrée */
}

/* Animations d'entrée */
@keyframes slide-in {
    from { transform: translateX(120%); }
    to { transform: translateX(0); }
}

/* Style de l'icône */
.toast-icon {
    font-size: 1.5rem;
    margin-right: 1rem;
    line-height: 1;
}

/* Couleurs et icônes pour chaque type de notification */
.toast-notification.success .toast-icon { color: #28a745; }
.toast-notification.warning .toast-icon { color: #ffc107; }
.toast-notification.danger .toast-icon { color: #dc3545; }
.toast-notification.info .toast-icon { color: #007bff; }

/* Style du bouton de fermeture */
.toast-notification .close-btn {
    position: absolute;
    top: 5px;
    right: 5px;
    background: none;
    border: none;
    font-size: 1rem;
    color: #aaa;
    cursor: pointer;
}

/* Barre de progression */
.toast-notification::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background-color: #ddd;
    animation: progress-bar 5s linear forwards;
}
.toast-notification.success::after { background-color: #28a745; }
.toast-notification.warning::after { background-color: #ffc107; }
.toast-notification.danger::after { background-color: #dc3545; }
.toast-notification.info::after { background-color: #007bff; }

@keyframes progress-bar {
    from { width: 100%; }
    to { width: 0%; }
}
  </style>
{% endblock %}

{% block content %}
<header class="d-flex justify-content-between align-items-center py-3 px-5 header-nav">
    <a href="#" class="logo-text text-decoration-none">RecoFlix</a>
   <form id="search-form" class="d-flex my-3" method="GET" action="{{ url_for('api_routes.search_films') }}">
    <input id="search-input" class="form-control me-2" type="search" name="query" placeholder="Rechercher un film..." aria-label="Search">
    <button class="btn btn-outline-light" type="submit">Rechercher</button>
</form>


    <div class="d-flex align-items-center">
        <button id="dark-mode-toggle" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 p-2 rounded-full transition-colors duration-200 hover:bg-gray-300 dark:hover:bg-gray-600 me-2">
            <i class="fas fa-moon" id="mode-icon"></i>
        </button>

        <div class="flex items-center space-x-2 me-3">
            <i class="fas fa-clock text-indigo-600"></i>
            <div id="time-spent-display" class="text-sm font-bold text-gray-800">00:00:00</div>
        </div>

        <a href="#favorites-section" class="nav-link me-3">
            <i class="fas fa-heart text-danger"></i> Mes Favoris
        </a>
        <a href="{{ url_for('api_routes.logout') }}" class="btn btn-outline-danger btn-sm rounded-pill">
            <i class="fas fa-sign-out-alt"></i> Déconnexion
        </a>
    </div>
</header>
 
    

<main class="container py-5">
    
    <div id="dynamic-alert-container"></div>

    <section id="hero-section" class="hero-film p-5 mb-5 shadow-sm">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="text-start">Le Voyage de Chihiro</h1>
                    <p class="lead text-muted">Genre: Animation, Fantastique, Aventure</p>
                    <p class="text-dark">Chihiro, une jeune fille de 10 ans... Un chef-d'œuvre de l'animation japonaise.</p>
                    <div class="mt-4">
                        <button
                            class="btn btn-action text-white me-2"
                            data-bs-toggle="modal"
                            data-bs-target="#filmDetailsModal"
                            data-title="Le Voyage de Chihiro"
                            data-genre="Animation, Fantastique, Aventure"
                            data-description="Chihiro, une jeune fille de 10 ans, déménage avec ses parents..."
                            data-rating="9.0"
                            data-image="{{ url_for('static', filename='css/images/voyage1.jpg') }}"
                            data-video-url="https://www.youtube.com/watch?v=Eyk1XckQWxY"
                            data-watch-url="https://video.antopie.org/w/8HSaxZeo6Nq1B2J1NEUDVr"
                            data-movie-id="12345">
                            <i class="fas fa-play me-2"></i> Voir les détails
                        </button>
                    </div>
                </div>
                <div class="col-md-6 d-flex justify-content-center">
                    <img src="{{ url_for('static', filename='css/images/voyage1.jpg') }}" alt="Le Voyage de Chihiro" class="img-fluid rounded-3 shadow-lg" style="max-height: 400px; object-fit: cover;">
                </div>
            </div>
        </div>
    </section>

    <section id="search-results-section" style="display: none;">
        <h2 class="section-title">Résultats de la Recherche</h2>
        <div id="search-results-row" class="scrollable-row mb-5">
            </div>
    </section>

    <section id="favorites-section">
    <h2 class="section-title">Mes Favoris</h2>
    <div id="favorites-row" class="scrollable-row mb-5">
    </div>
</section>

    <section id="new-releases-section">
        <h2 class="section-title">Nouveautés</h2>
        <div class="scrollable-row mb-5">
            {% set new_releases = [
                { "title": "Le Dernier Duel", "director_name": "Ridley Scott", "genre": "Drame, Historique", "desc": "Un drame historique captivant...", "rating": "8.1", "img": "film6.jpg", "video": "https://www.youtube.com/watch?v=jTLkTw_rXcQ", "watch": "https://www.youtube.com/watch?v=jTLkTw_rXcQ", "id": "6"},
                { "title": "Dune", "director_name": "Denis Villeneuve", "genre": "Science-fiction, Aventure", "desc": "Un chef-d'œuvre de science-fiction...", "rating": "8.4", "img": "film7.jpg", "video": "https://www.youtube.com/watch?v=n9xhJrPXop4", "watch": "https://www.youtube.com/watch?v=n9xhJrPXop4", "id": "7"},
                { "title": "Tenet", "director_name": "Christopher Nolan", "genre": "Action, Thriller", "desc": "Un thriller d'espionnage complexe...", "rating": "7.5", "img": "film8.jpg", "video": "https://www.youtube.com/watch?v=L3pk_TBkihU", "watch": "https://www.youtube.com/watch?v=L3pk_TBkihU", "id": "8"},
                { "title": "Spider-Man: No Way Home", "director_name": "Jon Watts", "genre": "Action, Fantastique", "desc": "L'univers de Spider-Man se confronte...", "rating": "8.2", "img": "film9.jpg", "video": "https://www.youtube.com/watch?v=JfVOs4VSpmA", "watch": "https://www.youtube.com/watch?v=JfVOs4VSpmA", "id": "9"},
            ] %}
            {% for film in new_releases %}
            <div class="film-card">
                <img src="{{ url_for('static', filename='css/images/' + film.img) }}" alt="{{ film.title }}"
                    data-bs-toggle="modal" data-bs-target="#filmDetailsModal"
                    data-title="{{ film.title }}" data-genre="{{ film.genre }}"
                    data-description="{{ film.desc }}" data-rating="{{ film.rating }}"
                    data-image="{{ url_for('static', filename='css/images/' + film.img) }}"
                    data-video-url="{{ film.video }}" data-watch-url="{{ film.watch }}" data-movie-id="{{ film.id }}">
                    <div class="film-title">{{ film.title }}</div>
            </div>
            {% endfor %}
        </div>
    </section>

   <section id="recommandations-section">
    <h2 class="section-title">Recommandations</h2>
    <div class="scrollable-row mb-5">
        {% set trending = [
            { "title": "Bayblon", "director_name": "Damien Chazelle", "genre": "Action, Aventure", "desc": "Un film d'action palpitant...", "rating": "8.5", "img": "film1.jpg", "video": "https://www.youtube.com/watch?v=50P1-oPvZOg", "watch": "https://www.dailymotion.com/video/x8o9vop", "id": "1", "director_img": "chazelle.jpg", "director_desc": "Damien Chazelle est un réalisateur, scénariste et producteur américain connu pour ses films musicaux et drames." },
            { "title": "Maria Réve", "director_name": "Léa Mysius", "genre": "Drame, Romance", "desc": "Une histoire d'amour émouvante...", "rating": "7.9", "img": "film2.jpg", "video": "https://www.youtube.com/watch?v=RbIl4VjibPc", "watch": "https://www.dailymotion.com/video/x9mr95s", "id": "2", "director_img": "mysius.jpg", "director_desc": "Léa Mysius est une réalisatrice et scénariste française. Son travail est souvent salué pour son originalité et sa profondeur." },
            { "title": "Barbie", "director_name": "Greta Gerwig", "genre": "Science-fiction, Thriller", "desc": "Un thriller de science-fiction...", "rating": "8.8", "img": "film3.jpg", "video": "https://www.youtube.com/watch?v=2oOzWcbVf1cv", "watch": "https://www.youtube.com/watch?v=CqHygiRKxkc", "id": "3", "director_img": "gerwig.jpg", "director_desc": "Greta Gerwig est une réalisatrice, scénariste et actrice américaine acclamée par la critique." },
            { "title": "Restart", "director_name": "Joe Wright", "genre": "Comédie, Famille", "desc": "Une comédie légère et amusante...", "rating": "7.2", "img": "film4.jpg", "video": "https://www.youtube.com/watch?v=pgq6tjnpMYs", "watch": "https://www.dailymotion.com/video/x9o0v96", "id": "4", "director_img": "wright.jpg", "director_desc": "Joe Wright est un réalisateur anglais, connu pour ses films d'époque et ses drames." },
            { "title": "Jumanji", "director_name": "Joe Johnston", "genre": "Action, Thriller", "desc": "Un film d'action intense...", "rating": "8.1", "img": "film5.jpg", "video": "https://www.youtube.com/embed/dQw4w9WgXcQ", "watch": "https://www.youtube.com/watch?v=RCaOZPZFrG4", "id": "5", "director_img": "johnston.jpg", "director_desc": "Joe Johnston est un réalisateur de films d'action et d'aventure, souvent pour des blockbusters." }
        ] %}
        {% for film in trending %}
        <div class="film-card">
            <img src="{{ url_for('static', filename='css/images/' + film.img) }}" alt="{{ film.title }}"
                data-bs-toggle="modal" data-bs-target="#filmDetailsModal"
                data-title="{{ film.title }}" data-genre="{{ film.genre }}"
                data-description="{{ film.desc }}" data-rating="{{ film.rating }}"
                data-image="{{ url_for('static', filename='css/images/' + film.img) }}"
                data-video-url="{{ film.video }}" data-watch-url="{{ film.watch }}" data-movie-id="{{ film.id }}">
            <div class="film-title">{{ film.title }}</div>
            <div class="director-link" 
                 data-bs-toggle="modal" 
                 data-bs-target="#directorDetailsModal"
                 data-director-name="{{ film.director_name }}"
                 data-director-role="Réalisateur"
                 data-director-image="{{ url_for('static', filename='css/images/' + film.director_img) }}"
                 data-director-description="{{ film.director_desc }}">
                <small class="text-muted"><i class="fas fa-user-circle me-1"></i> {{ film.director_name }}</small>
            </div>
        </div>
        {% endfor %}
    </div>
</section>
</main>

<div class="modal fade" id="filmDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalFilmTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body modal-body-film p-4">
                <img id="modalFilmImage" src="" class="shadow-sm">
                <div>
                    <p class="text-muted" id="modalFilmGenre"></p>
                    <p id="modalFilmDescription"></p>
                    <hr>
                    <h6>Bande-annonce :</h6>
                    <div class="ratio ratio-16x9 rounded shadow-sm">
                        <iframe id="modalFilmVideo" src="" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 d-flex justify-content-end">
                <a href="#" id="watchFilmBtn" class="btn btn-action text-white me-2" target="_blank">
                    <i class="fas fa-play-circle me-2"></i> Regarder le film
                </a>
                <button type="button" class="btn btn-action text-white" id="addToFavoritesBtn" data-movie-id="">
                    <i class="fas fa-heart me-2"></i> Ajouter aux favoris
                </button>
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="directorDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content rounded-3 shadow-lg">
            <div class="modal-header bg-dark text-white border-0 rounded-top">
                <h5 class="modal-title fw-bold">Profil de <span id="modalDirectorName"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center p-4 director-modal-body">
                <img id="modalDirectorImage" src="" class="rounded-circle mb-3 shadow">
                <h5 id="modalDirectorProfileName" class="fw-bold"></h5>
                <p class="text-muted small" id="modalDirectorRole"></p>
                <hr>
                <p class="small" id="modalDirectorDescription"></p>
            </div>
        </div>
    </div>
</div>

<button id="chatbot-toggle-btn" class="fixed-bottom-right shadow-lg">
    <i class="fas fa-robot"></i>
</button>

<div id="chatbot-container" class="fixed-bottom-right-lg hidden">
    <div class="chatbot-header">
        <h3 class="fw-bold">RecoFlix Assistant</h3>
        <button id="chatbot-close-btn" class="btn-close btn-close-white"></button>
    </div>
    <div id="chatbot-messages" class="chatbot-body">
        <div class="chat-message bot">
            Bonjour ! Je suis votre assistant RecoFlix. Posez-moi une question sur le cinéma ou demandez-moi une recommandation !
        </div>
    </div>
    <form id="chatbot-form" class="chatbot-footer">
        <input type="text" id="chatbot-input" placeholder="Tapez votre message..." class="form-control rounded-pill">
        <button type="submit" id="chatbot-send" class="btn btn-primary rounded-pill">
            <i class="fas fa-paper-plane"></i>
        </button>
    </form>
</div>
 
    
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    

    // --- LOGIQUE DU MODE SOMBRE ---
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const modeIcon = document.getElementById('mode-icon');
    const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

    // Fonction pour appliquer le thème
    function applyTheme(theme) {
        if (theme === 'dark') {
            document.body.classList.add('dark');
            modeIcon.classList.remove('fa-moon');
            modeIcon.classList.add('fa-sun');
        } else {
            document.body.classList.remove('dark');
            modeIcon.classList.remove('fa-sun');
            modeIcon.classList.add('fa-moon');
        }
    }

    // Charger le thème depuis le stockage local ou le thème système
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        applyTheme(savedTheme);
    } else {
        applyTheme(prefersDarkScheme.matches ? 'dark' : 'light');
    }

    // Écouteur pour le bouton de basculement
    darkModeToggle.addEventListener('click', () => {
        const currentTheme = document.body.classList.contains('dark') ? 'light' : 'dark';
        applyTheme(currentTheme);
        localStorage.setItem('theme', currentTheme);
    });

// --- LOGIQUE DU CHRONOMÈTRE (NOUVEAU) ---
    const timerDisplay = document.getElementById('time-spent-display');
    const storageKey = 'timeSpentOnPlatform';
    let startTime = parseInt(localStorage.getItem(storageKey) || 0, 10);
    
    // Fonction pour mettre à jour le chronomètre
    function updateTimer() {
        startTime++;
        const hours = Math.floor(startTime / 3600);
        const minutes = Math.floor((startTime % 3600) / 60);
        const seconds = startTime % 60;
        
        const formattedTime = [hours, minutes, seconds]
            .map(t => t.toString().padStart(2, '0'))
            .join(':');
            
        if (timerDisplay) {
            timerDisplay.textContent = formattedTime;
        }
        
        // Sauvegarder le temps dans le localStorage toutes les secondes
        localStorage.setItem(storageKey, startTime.toString());
    }
    
    // Démarrer le chronomètre
    setInterval(updateTimer, 1000);

    // --- FIN LOGIQUE DU CHRONOMÈTRE ---
    

   function showDynamicAlert(message, type) {
    const container = document.getElementById('dynamic-alert-container');
    if (!container) {
        console.warn('Container pour alert dynamique introuvable.');
        return;
    }
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.setAttribute('role', 'alert');
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    container.prepend(alert);
    setTimeout(() => {
        const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
        if (bsAlert) bsAlert.close();
    }, 5000);
}

    // Fonction pour générer une carte de film
    function createFilmCard(film, isFavorite = false) {
        const card = document.createElement('div');
        card.className = 'film-card';
        card.setAttribute('data-movie-id', film.id);

        let removeButtonHtml = '';
        if (isFavorite) {
            removeButtonHtml = `
                <button type="button" class="btn remove-favorite-btn" data-movie-id="${film.id}">
                    <i class="fas fa-times"></i>
                </button>
            `;
        }

        card.innerHTML = `
            ${removeButtonHtml}
            <img src="${film.image_url}" alt="${film.title}"
                data-bs-toggle="modal" data-bs-target="#filmDetailsModal"
                data-title="${film.title}" data-genre="${film.genre}"
                data-description="${film.description}" data-rating="${film.rating}"
                data-image="${film.image_url}"
                data-video-url="${film.video_url}" data-watch-url="${film.watch_url}" data-movie-id="${film.id}">
            <div class="film-title">${film.title}</div>
        `;
        return card;
    }

    // Gestion des favoris dynamiques
    async function renderFavorites() {
        const favoritesRow = document.getElementById('favorites-row');
        if (!favoritesRow) return;
        favoritesRow.innerHTML = `
            <div class="text-center p-5 w-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement des favoris...</span>
                </div>
            </div>
        `;
        try {
            const response = await fetch('/get_favorites');
            const favorites = await response.json();

            favoritesRow.innerHTML = '';
            if (favorites.length > 0) {
                favorites.forEach(film => {
                    favoritesRow.appendChild(createFilmCard(film, true));
                });
            } else {
                favoritesRow.innerHTML = '<p class="text-center w-100 mt-4">Vous n\'avez pas encore de films favoris.</p>';
            }
        } catch (error) {
            console.error('Erreur lors du chargement des favoris:', error);
            favoritesRow.innerHTML = '<p class="text-center w-100 mt-4 text-danger">Erreur de chargement des favoris.</p>';
        }
    }

    // Barre de recherche
    const searchForm = document.getElementById('search-form');
    const searchInput = document.getElementById('search-input');
    const searchResultsSection = document.getElementById('search-results-section');
    const searchResultsRow = document.getElementById('search-results-row');

    if (searchForm) {
        searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = searchInput.value.trim();
            if (query === '') {
                searchResultsSection.style.display = 'none';
                return;
            }

            searchResultsRow.innerHTML = `
                <div class="text-center p-5 w-100">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                </div>
            `;
            searchResultsSection.style.display = 'block';

            try {
                const response = await fetch(`/search_films?query=${encodeURIComponent(query)}`);
                const films = await response.json();

                searchResultsRow.innerHTML = '';
                if (films.length > 0) {
                    films.forEach(film => {
                        searchResultsRow.appendChild(createFilmCard(film));
                    });
                } else {
                    searchResultsRow.innerHTML = '<p class="text-center w-100 mt-4">Aucun film trouvé pour cette recherche.</p>';
                }

                searchResultsSection.scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Erreur de recherche:', error);
                searchResultsRow.innerHTML = '<p class="text-center w-100 mt-4">Une erreur est survenue lors de la recherche.</p>';
            }
        });
    }

    // Initialiser la modale Bootstrap filmDetailsModal
    const modalElement = document.getElementById('filmDetailsModal');
    let filmDetailsModalInstance = null;
    if (modalElement) {
        filmDetailsModalInstance = new bootstrap.Modal(modalElement);

        // Logique pour la modale du film (mettre à jour les infos quand elle s'ouvre)
        modalElement.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const title = button.getAttribute('data-title');
            const genre = button.getAttribute('data-genre');
            const desc = button.getAttribute('data-description');
            const rating = button.getAttribute('data-rating');
            const image = button.getAttribute('data-image');
            const video = button.getAttribute('data-video-url');
            const watchUrl = button.getAttribute('data-watch-url');
            const id = button.getAttribute('data-movie-id') || 'unknown';

            this.querySelector('#modalFilmTitle').textContent = title;
            this.querySelector('#modalFilmGenre').textContent = `Genre: ${genre}`;
            this.querySelector('#modalFilmDescription').textContent = desc;
            this.querySelector('#modalFilmImage').src = image;
            this.querySelector('#watchFilmBtn').href = watchUrl;
            this.querySelector('#addToFavoritesBtn').setAttribute('data-movie-id', id);

            let embed = '';
            if (video) {
                const embedMatch = video.match(/(?:youtube\.com\/embed\/)([^&?]+)/);
                const watchMatch = video.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&?]+)/);
                if (embedMatch) {
                    embed = `https://www.youtube.com/embed/${embedMatch[1]}?autoplay=0`;
                } else if (watchMatch) {
                    embed = `https://www.youtube.com/embed/${watchMatch[1]}?autoplay=0`;
                }
            }
            this.querySelector('#modalFilmVideo').src = embed;
        });
    } else {
        console.warn('Élément #filmDetailsModal introuvable');
    }
    // Gestion du bouton "Ajouter aux favoris"
// Ajout aux favoris avec confirmation
// Gestion du bouton "Ajouter aux favoris"
// Logique pour l'ajout de favoris AVEC confirmation
document.getElementById('addToFavoritesBtn').addEventListener('click', async () => {
    const addToFavoritesBtn = document.getElementById('addToFavoritesBtn');
    const id = addToFavoritesBtn.getAttribute('data-movie-id');

    if (!id || id === 'unknown') {
        showDynamicAlert('ID de film manquant.', 'danger');
        return;
    }

    const confirmAdd = confirm("Voulez-vous ajouter ce film aux favoris ?");
    if (!confirmAdd) return;

    try {
        const response = await fetch('/add_favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ film_id: id })
        });

        const data = await response.json();

        if (response.ok) {
            // ✅ Ajout réussi
            showDynamicAlert('Film ajouté aux favoris !', 'success');
            renderFavorites();
            closeModal(); // On ferme la modale seulement si succès
        } else if (response.status === 409) {
            // ⚠ Déjà en favoris — on affiche l'avertissement sans fermer
            showDynamicAlert(data.message || 'Ce film est déjà dans vos favoris.', 'warning');
        } else {
            // ❌ Erreur générique
            showDynamicAlert(data.message || 'Une erreur est survenue lors de l\'ajout du film.', 'danger');
        }
    } catch (error) {
        console.error('Erreur réseau:', error);
        showDynamicAlert('Erreur réseau lors de l\'ajout aux favoris.', 'danger');
    }
});

// Fonction pour fermer la modale proprement
function closeModal() {
    const modalElement = document.getElementById('filmDetailsModal');
    const modalInstance = bootstrap.Modal.getInstance(modalElement);
    if (modalInstance) {
        modalInstance.hide();
    }
}

    // Modale réalisateur
    document.addEventListener('click', e => {
        if (e.target.matches('[data-bs-toggle="modal"][data-bs-target="#directorDetailsModal"]')) {
            e.preventDefault();
            const btn = e.target;
            const name = btn.getAttribute('data-director-name');
            const role = btn.getAttribute('data-director-role');
            const image = btn.getAttribute('data-director-image');
            const description = btn.getAttribute('data-director-description');

            document.getElementById('modalDirectorName').textContent = name;
            document.getElementById('modalDirectorProfileName').textContent = name;
            document.getElementById('modalDirectorRole').textContent = role;
            document.getElementById('modalDirectorDescription').textContent = description;
            document.getElementById('modalDirectorImage').src = image;

            const directorModal = new bootstrap.Modal(document.getElementById('directorDetailsModal'));
            directorModal.show();
        }
        document.getElementById('directorDetailsModal').addEventListener('hidden.bs.modal', function () {
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
        backdrop.remove();
    }
});
    });

    // Chatbot (inchangé)
    const chatbotToggleBtn = document.getElementById('chatbot-toggle-btn');
    const chatbotContainer = document.getElementById('chatbot-container');
    const chatbotCloseBtn = document.getElementById('chatbot-close-btn');
    const chatbotForm = document.getElementById('chatbot-form');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotMessages = document.getElementById('chatbot-messages');

    if (chatbotToggleBtn && chatbotContainer && chatbotCloseBtn && chatbotForm && chatbotInput && chatbotMessages) {
        chatbotToggleBtn.addEventListener('click', () => {
            chatbotContainer.classList.toggle('hidden');
        });

        chatbotCloseBtn.addEventListener('click', () => {
            chatbotContainer.classList.add('hidden');
        });

        chatbotForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const message = chatbotInput.value.trim();
            if (message === '') return;

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user';
            userMessageDiv.textContent = message;
            chatbotMessages.appendChild(userMessageDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            chatbotInput.value = '';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message bot loading';
            loadingDiv.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            chatbotMessages.appendChild(loadingDiv);
            chatbotMessages.scrollTop = chatbotMessages.scrollHeight;

            try {
                const response = await fetch('{{ url_for("api_routes.chat") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });

                const data = await response.json();
                loadingDiv.textContent = data.response;
                loadingDiv.classList.remove('loading');
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            } catch (error) {
                console.error('Erreur:', error);
                loadingDiv.textContent = 'Désolé, une erreur est survenue.';
                loadingDiv.classList.add('error');
                chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
            }
        });
    }

    // Affiche les favoris au chargement de la page
    renderFavorites();

});
// Écouteur d'événements pour gérer la suppression des favoris
document.addEventListener('click', async (event) => {
    // Utiliser .closest() pour trouver le bouton de suppression, même si on clique sur l'icône
    const removeButton = event.target.closest('.remove-favorite-btn');
    
    // Si l'élément cliqué n'est pas le bouton de suppression, ne rien faire
    if (!removeButton) {
        return;
    }

    // Récupérer l'ID du film
    const movieId = removeButton.getAttribute('data-movie-id');
    
    // Demander une confirmation
    const confirmDelete = confirm("Voulez-vous vraiment supprimer ce film de vos favoris ?");
    if (!confirmDelete) {
        return;
    }

    try {
        const response = await fetch('/remove_favorite', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ film_id: movieId })
        });

        const data = await response.json();

        if (response.ok) {
            // Suppression réussie, on retire la carte de l'affichage
            showDynamicAlert('Film supprimé de vos favoris !', 'success');
            
            // Trouver l'élément parent de la carte de film et le supprimer
            const filmCard = removeButton.closest('.film-card');
            if (filmCard) {
                filmCard.remove();
            }
            
            // Recharger la liste des favoris après la suppression pour synchroniser
            // Si la liste est vide, cela affichera le bon message
            renderFavorites();
            
        } else {
            // Gérer les erreurs du serveur
            showDynamicAlert(data.message || 'Erreur lors de la suppression.', 'danger');
        }
    } catch (error) {
        console.error('Erreur réseau lors de la suppression:', error);
        showDynamicAlert('Erreur réseau. Impossible de supprimer le film.', 'danger');
    }
});
// Logique pour la modale du réalisateur
document.addEventListener('click', e => {
    // Utiliser closest() pour trouver l'élément parent qui a les attributs de la modale
    const btn = e.target.closest('[data-bs-toggle="modal"][data-bs-target="#directorDetailsModal"]');
    
    // Si l'élément cliqué ou son parent n'est pas le bouton de la modale, ne rien faire
    if (!btn) {
        return;
    }

    e.preventDefault();
    
    // On peut maintenant obtenir les attributs de 'btn' en toute sécurité
    const name = btn.getAttribute('data-director-name');
    const role = btn.getAttribute('data-director-role');
    const image = btn.getAttribute('data-director-image');
    const description = btn.getAttribute('data-director-description');

    document.getElementById('modalDirectorName').textContent = name;
    document.getElementById('modalDirectorProfileName').textContent = name;
    document.getElementById('modalDirectorRole').textContent = role;
    document.getElementById('modalDirectorDescription').textContent = description;
    document.getElementById('modalDirectorImage').src = image;

    const directorModal = new bootstrap.Modal(document.getElementById('directorDetailsModal'));
    directorModal.show();
});
</script>

{% endblock %}
