{% extends "base.html" %} {# Assurez-vous d'avoir un fichier base.html pour un layout commun #}

{% block title %}Ma Liste de Films - RecoFlix{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4">Ma Liste de Films</h1>

    {# Affichage des messages Flash de Flask #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if my_films %}
        <div class="row">
            {% for film in my_films %}
            <div class="col-md-4 mb-4">
                <div class="card h-100">
                    {# Affiche l'image du film, ou une image par défaut #}
                    {% if film.image_url and film.image_url != 'None' %}
                        <img src="{{ film.image_url }}" class="card-img-top" alt="{{ film.title }}" style="height: 300px; object-fit: cover;">
                    {% else %}
                        <img src="https://via.placeholder.com/300x450?text=No+Image" class="card-img-top" alt="No Image" style="height: 300px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ film.title }}</h5>
                        <p class="card-text"><strong>Genre:</strong> {{ film.genre if film.genre and film.genre != 'None' else 'N/A' }}</p>
                        <p class="card-text"><strong>Note:</strong> {{ film.rating if film.rating and film.rating != 'None' else 'N/A' }}/10</p>
                        {# Affiche une description courte #}
                        <p class="card-text flex-grow-1">{{ film.description[:100] if film.description else '' }}...</p>
                        
                        <div class="mt-auto">
                            {# Indique si le film a été vu ou non #}
                            {% if film.watched %}
                                <span class="badge bg-success mb-2">Déjà vu !</span>
                            {% else %}
                                <span class="badge bg-secondary mb-2">À voir</span>
                            {% endif %}

                            {# Bouton pour regarder le film, visible uniquement s'il y a une URL vidéo #}
                            {% if film.video_url and film.video_url != 'None' %}
                                <a href="{{ url_for('api_routes.watch_film', film_id=film.id) }}" class="btn btn-primary btn-sm me-2">Regarder</a>
                            {% else %}
                                <button class="btn btn-secondary btn-sm me-2" disabled>Pas de vidéo</button>
                            {% endif %}
                            
                            {# Bouton pour retirer le film de la liste #}
                            <button class="btn btn-danger btn-sm remove-from-list-btn" data-film-id="{{ film.id }}">Retirer de ma liste</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p>Votre liste est vide. Ajoutez des films pour les retrouver ici !</p>
        <a href="{{ url_for('api_routes.dashboard') }}" class="btn btn-info">Explorer les films</a>
    {% endif %}
</div>

{# Script pour le bouton "Retirer de ma liste" (utilise AJAX) #}
<script>
    document.querySelectorAll('.remove-from-list-btn').forEach(button => {
        button.addEventListener('click', function() {
            const filmId = this.dataset.filmId;
            if (confirm('Êtes-vous sûr de vouloir retirer ce film de votre liste ?')) {
                fetch('/remove_from_list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ film_id: filmId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' || data.status === 'info') {
                        alert(data.message); // Affiche un message simple
                        window.location.reload(); // Recharge la page pour mettre à jour la liste
                    } else {
                        alert('Erreur: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Une erreur est survenue lors de la suppression.');
                });
            }
        });
    });
</script>

{% endblock %}